var release_sites = {
    "type": "FeatureCollection",
    "crs": { "type": "name", "properties": { "name": "release_sites" } },
    "features": [
    { "type": "Feature", "properties": { "ID": 1, "release_date": "2016-06-08", "release_group": 1.0, "release_time": "1899-12-30 19:36:00.000", "lat_dd_mm": "47 16.338", "lon_dd_mm": "124 51.729", "tags": "all tags", "notes_comments": null, "lat": 47.2723, "lon": 124.86215 }, "geometry": { "type": "Point", "coordinates": [ -124.86215, 47.2723 ] } },
    { "type": "Feature", "properties": { "ID": 2, "release_date": "2016-06-09", "release_group": 1.0, "release_time": "1899-12-30 20:01:00.000", "lat_dd_mm": "47 16.103", "lon_dd_mm": "124 53.036", "tags": "all tags", "notes_comments": null, "lat": 47.268383333333333, "lon": 124.88393333333333 }, "geometry": { "type": "Point", "coordinates": [ -124.883933333333331, 47.268383333333333 ] } },
    ]
    };

var first_message = {
    "type": "FeatureCollection",
    "crs": { "type": "name", "properties": { "name": "first_message" } },
    "features": [
    { "type": "Feature", "properties": { "greatcircle_distance_km": "22.5", "geodesic_distance_km": "22.5", "tag_sn": 1338, "Platform ID No.": 149508, "deployment": 3, "release_date": "2016-06-08 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:03:40", "report_status": "on time", "Latitude": 47.47271, "Longitude": -124.90221, "loc_quality": "3", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -124.90221, 47.47271 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "86.1", "geodesic_distance_km": "86.1", "tag_sn": 1397, "Platform ID No.": 149511, "deployment": 3, "release_date": "2016-06-08 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 22:05:26", "report_status": "on time", "Latitude": 46.53051, "Longitude": -124.53921, "loc_quality": "1", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -124.53921, 46.53051 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "139.0", "geodesic_distance_km": "139.1","tag_sn": 1465, "Platform ID No.": 149514, "deployment": 3, "release_date": "2016-06-08 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:55:00", "report_status": "on time", "Latitude": 48.31265, "Longitude": -125.89269, "loc_quality": "A", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -125.89269, 48.31265 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "22.0", "geodesic_distance_km": "22.0", "tag_sn": 1474, "Platform ID No.": 149515, "deployment": 3, "release_date": "2016-06-08 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 17:39:32", "report_status": "on time", "Latitude": 47.467, "Longitude": -124.91584, "loc_quality": "1", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -124.91584, 47.467 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "95.3", "geodesic_distance_km": "95.3", "tag_sn": 1506, "Platform ID No.": 149520, "deployment": 3, "release_date": "2016-06-08 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 13:35:07", "report_status": "on time", "Latitude": 48.06047, "Longitude": -125.36201, "loc_quality": "2", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -125.36201, 48.06047 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "19.8", "geodesic_distance_km": "19.8", "tag_sn": 1518, "Platform ID No.": 149521, "deployment": 3, "release_date": "2016-06-09 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:02:57", "report_status": "on time", "Latitude": 47.44508, "Longitude": -124.85007, "loc_quality": "A", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -124.85007, 47.44508 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "98.4", "geodesic_distance_km": "98.4", "tag_sn": 1541, "Platform ID No.": 149523, "deployment": 3, "release_date": "2016-06-09 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:01:47", "report_status": "on time", "Latitude": 48.0828, "Longitude": -125.39746, "loc_quality": "0", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -125.39746, 48.0828 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "115.1", "geodesic_distance_km": "115.1", "tag_sn": 1548, "Platform ID No.": 149524, "deployment": 3, "release_date": "2016-06-08 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-07 21:26:32", "report_status": "early", "Latitude": 46.24963, "Longitude": -124.62613, "loc_quality": "3", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -124.62613, 46.24963 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "4.2", "geodesic_distance_km": "4.2", "tag_sn": 1554, "Platform ID No.": 149525, "deployment": 3, "release_date": "2016-06-09 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 20:58:12", "report_status": "on time", "Latitude": 47.28903, "Longitude": -124.83728, "loc_quality": "B", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -124.83728, 47.28903 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "18.0", "geodesic_distance_km": "18.0", "tag_sn": 1555, "Platform ID No.": 149526, "deployment": 3, "release_date": "2016-06-09 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 13:35:05", "report_status": "on time", "Latitude": 47.42307, "Longitude": -124.81156, "loc_quality": "1", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -124.81156, 47.42307 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "83.1", "geodesic_distance_km": "83.1", "tag_sn": 1556, "Platform ID No.": 149527, "deployment": 3, "release_date": "2016-06-08 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-07-02 23:19:59", "report_status": "early", "Latitude": 47.99783, "Longitude": -125.13071, "loc_quality": "B", "in_ocean": 1, "VALID": "N", "Notes": "Early pop but location is not anywhere near crush limit of tag" }, "geometry": { "type": "Point", "coordinates": [ -125.13071, 47.99783 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "126.9", "geodesic_distance_km": "126.9", "tag_sn": 1559, "Platform ID No.": 149528, "deployment": 3, "release_date": "2016-06-08 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 13:57:03", "report_status": "on time", "Latitude": 46.13533, "Longitude": -124.72064, "loc_quality": "B", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -124.72064, 46.13533 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "37.4", "geodesic_distance_km": "37.4", "tag_sn": 1576, "Platform ID No.": 149547, "deployment": 3, "release_date": "2016-06-09 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:03:44", "report_status": "on time", "Latitude": 46.9399, "Longitude": -124.99088, "loc_quality": "3", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -124.99088, 46.9399 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "100.9", "geodesic_distance_km": "101.0", "tag_sn": 1577, "Platform ID No.": 149544, "deployment": 3, "release_date": "2016-06-09 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 13:34:06", "report_status": "on time", "Latitude": 48.05133, "Longitude": -125.56451, "loc_quality": "A", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -125.56451, 48.05133 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "2.3", "geodesic_distance_km": "2.3", "tag_sn": 1619, "Platform ID No.": 149538, "deployment": 3, "release_date": "2016-06-08 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:03:57", "report_status": "on time", "Latitude": 47.26126, "Longitude": -124.88722, "loc_quality": "2", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -124.88722, 47.26126 ] } },
    { "type": "Feature", "properties": { "greatcircle_distance_km": "1.3", "geodesic_distance_km": "1.3", "tag_sn": 1622, "Platform ID No.": 149539, "deployment": 3, "release_date": "2016-06-09 00:00:00", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 17:38:21", "report_status": "on time", "Latitude": 47.27998, "Longitude": -124.88843, "loc_quality": "3", "in_ocean": 1, "VALID": "Y", "Notes": null }, "geometry": { "type": "Point", "coordinates": [ -124.88843, 47.27998 ] } }
    ]
    };

var distance = {
  "type": "FeatureCollection",
  "crs": { "type": "name", "properties": { "name": "distance" } },
  "features": [
  { "type": "Feature", "properties": { "greatcircle_distance_km": "22.48786559252801", "geodesic_distance_km": "22.48568511167295", "tag_sn": 1338, "deployment": 3, "release_date": "2016-06-08 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:03:40", "pop_Geom": "POINT(-124.90221 47.47271)", "rel_Geom": "POINT(-124.86215 47.2723)" }, "geometry": { "type": "LineString", "coordinates": [ [ -124.90221, 47.47271 ], [ -124.86215, 47.2723 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "86.0549372170801", "geodesic_distance_km": "86.05672367297295", "tag_sn": 1397, "deployment": 3, "release_date": "2016-06-08 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 22:05:26", "pop_Geom": "POINT(-124.53921 46.53051)", "rel_Geom": "POINT(-124.86215 47.2723)" }, "geometry": { "type": "LineString", "coordinates": [ [ -124.53921, 46.53051 ], [ -124.86215, 47.2723 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "138.9532734768575", "geodesic_distance_km": "139.0721208860036", "tag_sn": 1465, "deployment": 3, "release_date": "2016-06-08 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:55:00", "pop_Geom": "POINT(-125.89269 48.31265)", "rel_Geom": "POINT(-124.86215 47.2723)" }, "geometry": { "type": "LineString", "coordinates": [ [ -125.89269, 48.31265 ], [ -124.86215, 47.2723 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "22.0240118124145", "geodesic_distance_km": "22.02293630831458", "tag_sn": 1474, "deployment": 3, "release_date": "2016-06-08 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 17:39:32", "pop_Geom": "POINT(-124.91584 47.467)", "rel_Geom": "POINT(-124.86215 47.2723)" }, "geometry": { "type": "LineString", "coordinates": [ [ -124.91584, 47.467 ], [ -124.86215, 47.2723 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "95.29893951814117", "geodesic_distance_km": "95.33428426300716", "tag_sn": 1506, "deployment": 3, "release_date": "2016-06-08 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 13:35:07", "pop_Geom": "POINT(-125.36201 48.06047)", "rel_Geom": "POINT(-124.86215 47.2723)" }, "geometry": { "type": "LineString", "coordinates": [ [ -125.36201, 48.06047 ], [ -124.86215, 47.2723 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "19.81269113779407", "geodesic_distance_km": "19.81062881619605", "tag_sn": 1518, "deployment": 3, "release_date": "2016-06-09 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:02:57", "pop_Geom": "POINT(-124.85007 47.44508)", "rel_Geom": "POINT(-124.883933 47.268383)" }, "geometry": { "type": "LineString", "coordinates": [ [ -124.85007, 47.44508 ], [ -124.883933333333331, 47.268383333333333 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "98.38237571328368", "geodesic_distance_km": "98.41853992648483", "tag_sn": 1541, "deployment": 3, "release_date": "2016-06-09 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:01:47", "pop_Geom": "POINT(-125.39746 48.0828)", "rel_Geom": "POINT(-124.883933 47.268383)" }, "geometry": { "type": "LineString", "coordinates": [ [ -125.39746, 48.0828 ], [ -124.883933333333331, 47.268383333333333 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "115.1281321484311", "geodesic_distance_km": "115.1070958188418", "tag_sn": 1548, "deployment": 3, "release_date": "2016-06-08 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-07 21:26:32", "pop_Geom": "POINT(-124.62613 46.24963)", "rel_Geom": "POINT(-124.86215 47.2723)" }, "geometry": { "type": "LineString", "coordinates": [ [ -124.62613, 46.24963 ], [ -124.86215, 47.2723 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "4.20205603223812", "geodesic_distance_km": "4.210491980865895", "tag_sn": 1554, "deployment": 3, "release_date": "2016-06-09 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 20:58:12", "pop_Geom": "POINT(-124.83728 47.28903)", "rel_Geom": "POINT(-124.883933 47.268383)" }, "geometry": { "type": "LineString", "coordinates": [ [ -124.83728, 47.28903 ], [ -124.883933333333331, 47.268383333333333 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "18.04402006611393", "geodesic_distance_km": "18.0462856273952", "tag_sn": 1555, "deployment": 3, "release_date": "2016-06-09 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 13:35:05", "pop_Geom": "POINT(-124.81156 47.42307)", "rel_Geom": "POINT(-124.883933 47.268383)" }, "geometry": { "type": "LineString", "coordinates": [ [ -124.81156, 47.42307 ], [ -124.883933333333331, 47.268383333333333 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "83.14697866474263", "geodesic_distance_km": "83.15303148575541", "tag_sn": 1556, "deployment": 3, "release_date": "2016-06-08 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-07-02 23:19:59", "pop_Geom": "POINT(-125.13071 47.99783)", "rel_Geom": "POINT(-124.86215 47.2723)" }, "geometry": { "type": "LineString", "coordinates": [ [ -125.13071, 47.99783 ], [ -124.86215, 47.2723 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "126.8850765879297", "geodesic_distance_km": "126.8537333606028", "tag_sn": 1559, "deployment": 3, "release_date": "2016-06-08 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 13:57:03", "pop_Geom": "POINT(-124.72064 46.13533)", "rel_Geom": "POINT(-124.86215 47.2723)" }, "geometry": { "type": "LineString", "coordinates": [ [ -124.72064, 46.13533 ], [ -124.86215, 47.2723 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "37.41187673075876", "geodesic_distance_km": "37.40988045102647", "tag_sn": 1576, "deployment": 3, "release_date": "2016-06-09 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:03:44", "pop_Geom": "POINT(-124.99088 46.9399)", "rel_Geom": "POINT(-124.883933 47.268383)" }, "geometry": { "type": "LineString", "coordinates": [ [ -124.99088, 46.9399 ], [ -124.883933333333331, 47.268383333333333 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "100.8821729888019", "geodesic_distance_km": "100.9506585642027", "tag_sn": 1577, "deployment": 3, "release_date": "2016-06-09 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 13:34:06", "pop_Geom": "POINT(-125.56451 48.05133)", "rel_Geom": "POINT(-124.883933 47.268383)" }, "geometry": { "type": "LineString", "coordinates": [ [ -125.56451, 48.05133 ], [ -124.883933333333331, 47.268383333333333 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "2.255080585491994", "geodesic_distance_km": "2.259620464187059", "tag_sn": 1619, "deployment": 3, "release_date": "2016-06-08 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 14:03:57", "pop_Geom": "POINT(-124.88722 47.26126)", "rel_Geom": "POINT(-124.86215 47.2723)" }, "geometry": { "type": "LineString", "coordinates": [ [ -124.88722, 47.26126 ], [ -124.86215, 47.2723 ] ] } },
  { "type": "Feature", "properties": { "greatcircle_distance_km": "1.333372068269052", "geodesic_distance_km": "1.333413671273296", "tag_sn": 1622, "deployment": 3, "release_date": "2016-06-09 00:00:00.000", "mission_end": "2016-08-21 13:00:00", "first_message": "2016-08-21 17:38:21", "pop_Geom": "POINT(-124.88843 47.27998)", "rel_Geom": "POINT(-124.883933 47.268383)" }, "geometry": { "type": "LineString", "coordinates": [ [ -124.88843, 47.27998 ], [ -124.883933333333331, 47.268383333333333 ] ] } }
  ]
  };



// Map tile layers
var osm = L.tileLayer( 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
})

var Esri_OceanBasemap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Sources: GEBCO, NOAA, CHS, OSU, UNH, CSUMB, National Geographic, DeLorme, NAVTEQ, and Esri',
	maxZoom: 13
})


// Create map varable
var mymap = L.map('mapid', {
  center: [47, -124],
  zoom: 6,
  layers: [Esri_OceanBasemap] //, osm, Thunderforest_SpinalMap],
});


var distanceStyle = {
    "color": "#424242",
    "weight": 1.5,
    "opacity": 0.85
};

var releaseStyle = {
    radius: 5,
    fillColor: "#3299BB",
    color: "#424242",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.9
};


function getPopupColor(d) {
    return d == 'early'   ? '#ED303C' :
           d == 'on time' ? '#FF9900' :
                            '#424242';
}

function popupStyle(feature) {
  return {
      radius: 4,
      fillColor: getPopupColor(feature.properties.report_status),
      color: "#424242",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.9
  };
}

// specify popup options
var customOptions =
    {
    'className' : 'custom'
    }



var lines = L.geoJson(distance, {
    style: distanceStyle
})
lines.addTo(mymap);

var relases = L.geoJson(release_sites, {
  pointToLayer: function (feature, latlng) {
      return L.circleMarker(latlng, releaseStyle);
  },
  onEachFeature: function (feature, layer) {
    layer.bindPopup("<h3>Release Site<br></h3>" +
                    "<hr>" +
                    "<b>Release Date: </b>" + feature.properties.release_date);
  }
})
relases.addTo(mymap);



var popups = L.geoJson(first_message, {
    pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, null);
    },
    onEachFeature: function (feature, layer) {
      layer.bindPopup("<h3>Popup Site - Tag # " + feature.properties.tag_sn + "<br></h3>" +
                      "<hr>" +
                      "<b>First Message: </b>" + feature.properties.first_message + "<br>" +
                      "<b>Location Quality: </b>" + feature.properties.loc_quality + "<br>" +
                      "<b>Coordinates: </b>" + feature.properties.Latitude + ", "+ feature.properties.Longitude + "<br>" +
                      "<b>Distance Traveled : </b>" + feature.properties.geodesic_distance_km + " km", customOptions);
    },
    style: popupStyle,
})

popups.addTo(mymap);



var baseMaps = {
    "ESRI OceanBasemap": Esri_OceanBasemap,
    "Open Steet Maps": osm,
};


var layer_control = L.control.layers(baseMaps, null, {position:'topleft'})
layer_control.addTo(mymap);

var legend = L.control({position: 'bottomleft'});

legend.onAdd = function (mymap) {

    var div = L.DomUtil.create('div', 'info legend'),
        grades = ['on time', 'early'],
        labels = [];

    div.innerHTML = '<h3 style="text-align:center;">Legend</h3><hr>'
    div.innerHTML += '<i style="background:#3299BB"></i>&nbsp release site'
    // loop through our density intervals and generate a label with a colored square for each interval
    div.innerHTML += '<h4 style="text-align:center;">Pop Up Locations</h4><hr>'
    for (var i = 0; i < grades.length; i++) {

        div.innerHTML +=
            '<i class="circle" style="background:' + getPopupColor(grades[i]) + '"></i> ' +
            (grades[i] ? '&nbsp; ' + grades[i] + '<br>' : '+');
    }

    return div;
};

legend.addTo(mymap);
